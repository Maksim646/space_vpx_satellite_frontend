<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Dashboard</title>
  <link rel="stylesheet" href="styles_projects.css">
</head>
<body>

  <header>
    <div class="user-info">
      <span id="user-name">Загрузка...</span>
    </div>
  </header>

  <main class="dashboard-container">

    <aside class="sidebar left-sidebar">
      <button class="sidebar-button">Frames</button>
      <button class="sidebar-button">Solar panels</button>
      <button class="sidebar-button"></button>
      <button class="sidebar-button"></button>
    </aside>

    <section class="main-content">
      <button class="create-project-button">Create new project +</button>

      <!-- Модальное окно для создания нового проекта -->
      <div id="create-project-modal" class="modal">
        <div class="modal-content">
          <span class="close-button" id="close-modal">&times;</span>
          <h2>Create new project</h2>
          <input type="text" id="project-name-input" placeholder="Project name">
          <button id="submit-project-button">Create project</button>
        </div>
      </div>

      <div class="center-container">
        <div class="table-container">
            <div class="table-cell wide-cell"></div>  <!-- Wide cell spanning two columns -->
            <div class="table-cell">название</div>
            <div class="table-cell">Проект 1</div>
            <div class="table-cell">Проект 2</div>
            <div class="table-cell">Проект 3</div>
            <div class="table-cell">Проект 4</div>
            <div class="table-cell">Проект 5</div>
            <div class="table-cell">Проект 6</div>
            <div class="table-cell">Проект 7</div>
            <div class="table-cell">Проект 8</div>
        </div>
    </div>
      </div>
    </section>

    <aside class="sidebar right-sidebar">
        <div class="right-project-item">{{ project_name }}</div>
        <div class="right-project-item">{{ project_name }}</div>
        <div class="right-project-item"></div>
        <div class="right-project-item"></div>
        <div class="right-project-item"></div>
        <div class="right-project-item"></div>
        <div class="right-project-item"></div>
        <div class="right-project-item"></div>
    </aside>

  </main>

  <footer>
    <button class="next-page-button">Next page</button>
  </footer>

  <script>
    const accessToken = localStorage.getItem('access_token');

    // Функция для получения данных пользователя с бэкенда
    async function fetchUserData() {
      if (!accessToken) {
        console.warn("Токен доступа не найден в localStorage.");
        document.getElementById("user-name").textContent = "Требуется авторизация";
        return;
      }

      try {
        const response = await fetch("http://localhost:8000/user/get_me", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        document.getElementById("user-name").textContent = data.name;

      } catch (error) {
        console.error("Ошибка при получении данных пользователя:", error);
        document.getElementById("user-name").textContent = "Ошибка загрузки имени";
      }
    }

    async function fetchUserProjects() {
      if (!accessToken) {
        console.warn("Токен доступа не найден в localStorage.");
        return;
      }

      const offset = 0;
      const limit = 8;
      const sortField = "created_at";

      const url = `http://localhost:8000/projects/user_projects?offset=${offset}&limit=${limit}&sort[field]=${sortField}`;

      try {
        const response = await fetch(url, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        displayProjects(data.projects);

      } catch (error) {
        console.error("Ошибка при получении проектов:", error);
        const rightSidebar = document.querySelector('.right-sidebar');
        rightSidebar.innerHTML = "Ошибка загрузки проектов";
      }
    }

    // Функция для отображения проектов в right-sidebar
    function displayProjects(projects) {
      const rightSidebar = document.querySelector('.right-sidebar');
      rightSidebar.innerHTML = "";

      if (projects.length === 0) {
        const noProjectsDiv = document.createElement("div");
        noProjectsDiv.classList.add("right-project-item");
        noProjectsDiv.textContent = "Нет проектов";
        rightSidebar.appendChild(noProjectsDiv);
      } else {
        projects.forEach(project => {
          const projectDiv = document.createElement("div");
          projectDiv.classList.add("right-project-item");
          projectDiv.textContent = project.project_name; // Используем имя проекта из данных
          project.project_name; // Используем имя проекта из данных
          rightSidebar.appendChild(projectDiv);
        });
      }
    }

    const modal = document.getElementById("create-project-modal");
    const createProjectButton = document.querySelector(".create-project-button");
    const closeModalButton = document.getElementById("close-modal");
    const submitProjectButton = document.getElementById("submit-project-button");
    const projectNameInput = document.getElementById("project-name-input");

    // Открываем модальное окно при нажатии на кнопку
    createProjectButton.onclick = function() {
      modal.style.display = "block";
    }

    // Закрываем модальное окно
    closeModalButton.onclick = function() {
      modal.style.display = "none";
    }

    // Закрываем модальное окно при клике вне его
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    // Обработка создания нового проекта
    submitProjectButton.onclick = async function() {
      const projectName = projectNameInput.value.trim();
      if (!projectName) {
        alert("Project name");
        return;
      }

      const url = "http://localhost:8000/cube_sat_project"; // Замените на ваш URL для создания проекта

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ project_name: projectName })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        // Добавляем новый проект в список
        displayProjects([...document.querySelectorAll('.right-project-item')].map(item => ({ project_name: item.textContent })), { project_name: data.project_name });

        // Закрываем модальное окно
        modal.style.display = "none";
        projectNameInput.value = ""; // Очищаем поле ввода

        fetchUserProjects();

      } catch (error) {
        console.error("Ошибка при создании проекта:", error);
        alert("Ошибка при создании проекта. Пожалуйста, попробуйте еще раз.");
      }
    }

    // Вызываем функции при загрузке страницы
    fetchUserData();
    fetchUserProjects();
  </script>

</body>
</html>